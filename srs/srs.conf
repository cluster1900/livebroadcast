daemon on;
worker_processes auto;

error_log /var/log/srs/error.log warning;
pid /var/run/srs.pid;

events {
    worker_connections 10240;
}

rtmp {
    server {
        listen 1935;
        chunk_size 8192;
        ack_window 5000;

        live {
            app live;
            live_record on;
            gop_cache off;
        }

        hls {
            enabled on;
            hls_path /usr/local/srs/objs/nginx/html;
            hls_fragment 10s;
            hls_window 60s;
        }

        http_static {
            enabled on;
            dir /usr/local/srs/objs/nginx/html;
        }
    }
}

http {
    server {
        listen 8080;

        location / {
            root /usr/local/srs/objs/nginx/html;
        }

        location /api/ {
            proxy_pass http://api:8888/;
        }

        location /rtc/ {
            rtc;
            rtc_num_trials 3;
        }
    }
}

rtc_server {
    enabled on;
    listen 8000;
    candidate $CANDIDATE;
}

vhost __defaultVhost__ {
    rtc {
        enabled on;
        rtmp_to_rtc on;
        rtc_to_rtmp on;
    }

    dvr {
        enabled on;
        dvr_path /recordings/[app]/[stream]/[timestamp].mp4;
        dvr_plan session;
        dvr_duration 1800;
        dvr_wait_keyframe on;
    }

    transcode {
        enabled on;

        engine ff {
            enabled on;
            vcodec libx264;
            vbitrate 1500;
            vwidth 1280;
            vheight 720;
            vfps 30;
            vprofile main;
            acodec aac;
            abitrate 128;
            asample_rate 48000;
            output rtmp://127.0.0.1/live/[stream]_hd;
        }
    }
}
